<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>質問詳細 - 学生知恵袋</title>
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/threads.css">
  <link rel="stylesheet" href="css/forms.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo">学生知恵袋</a>

        <nav>
          <div class="logged-in" style="display: none;">
            <span id="user-info"></span>
            <a href="new-thread.html" class="btn-primary">質問する</a>
            <a href="#" id="logout-button">ログアウト</a>
          </div>

          <div class="logged-out">
            <a href="login.html">ログイン</a>
            <a href="signup.html" class="btn-primary">アカウント作成</a>
          </div>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- エラーメッセージ -->
    <div id="error-message" class="error-message"></div>

    <!-- 成功メッセージ -->
    <div id="success-message" class="success-message"></div>

    <!-- ローディング -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <!-- スレッド詳細 -->
    <div id="thread-detail" class="thread-detail" style="display: none;">
      <!-- JavaScriptで動的に生成 -->
    </div>

    <!-- 回答セクション -->
    <div id="answers-section" class="answers-section" style="display: none;">
      <h2 class="answers-header">回答 (<span id="answers-count">0</span>件)</h2>
      <div id="answers-list">
        <!-- JavaScriptで動的に生成 -->
      </div>
    </div>

    <!-- 回答フォーム -->
    <div id="answer-form-container" class="answer-form logged-in" style="display: none;">
      <h3 class="answer-form-title">回答を投稿</h3>
      <form id="answer-form">
        <div class="form-group">
          <textarea
            id="answer-content"
            class="form-textarea"
            placeholder="回答を入力してください"
            required
          ></textarea>
        </div>
        <button type="submit" class="form-button">回答する</button>
      </form>
    </div>

    <!-- ログインを促すメッセージ -->
    <div class="logged-out" style="display: none; text-align: center; padding: 2rem; background: #fff; border-radius: 8px; margin-top: 2rem;">
      <p>回答するには<a href="login.html" style="color: #1a73e8;">ログイン</a>してください</p>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2024 学生知恵袋. All rights reserved.</p>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script>
    let threadId = null;
    let currentThread = null;
    let currentUser = null;

    // URLからスレッドIDを取得
    function getThreadIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return parseInt(params.get('id'));
    }

    // スレッド詳細を表示
    async function loadThreadDetail() {
      threadId = getThreadIdFromUrl();

      if (!threadId) {
        showError('スレッドIDが指定されていません');
        return;
      }

      try {
        showLoading();

        const thread = await fetchThreadDetail(threadId);
        currentThread = thread;

        hideLoading();
        renderThreadDetail(thread);
        showElement('#thread-detail');

        // 回答を読み込み
        loadAnswers();
      } catch (error) {
        hideLoading();
        showError(error.message || 'スレッドの読み込みに失敗しました');
      }
    }

    function renderThreadDetail(thread) {
      const container = document.getElementById('thread-detail');

      const statusClass = thread.status === 'open' ? 'status-open' : 'status-resolved';
      const statusText = thread.status === 'open' ? '未解決' : '解決済み';

      container.innerHTML = `
        <div class="thread-detail-header">
          <div>
            <h1 class="thread-detail-title">${escapeHtml(thread.title)}</h1>
            <div class="thread-meta">
              <span class="thread-tag">${escapeHtml(thread.subject_tag?.name || '')}</span>
              <span class="thread-status ${statusClass}">${statusText}</span>
            </div>
          </div>
        </div>
        <div class="thread-detail-content">${nl2br(thread.content)}</div>
        <div class="thread-meta">
          <span>投稿者: ${escapeHtml(thread.user?.display_name || thread.user?.email || '')}</span>
          <span>${formatDate(thread.created_at)}</span>
          ${thread.deadline ? `<span>締切: ${formatDate(thread.deadline)}</span>` : ''}
        </div>
        <div id="thread-actions" class="thread-actions"></div>
      `;
    }

    // 回答一覧を読み込み
    async function loadAnswers() {
      try {
        const answers = await fetchAnswers(threadId);

        showElement('#answers-section');
        document.getElementById('answers-count').textContent = answers.length;

        if (answers.length === 0) {
          document.getElementById('answers-list').innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">まだ回答がありません</p>';
        } else {
          renderAnswers(answers);
        }

        // 回答フォームを表示（ログイン済みで未解決の場合）
        if (isLoggedIn() && currentThread.status === 'open') {
          const now = new Date();
          const deadline = currentThread.deadline ? new Date(currentThread.deadline) : null;

          if (!deadline || deadline > now) {
            showElement('#answer-form-container');
          }
        }
      } catch (error) {
        showError(error.message || '回答の読み込みに失敗しました');
      }
    }

    function renderAnswers(answers) {
      const container = document.getElementById('answers-list');
      container.innerHTML = '';

      // ベストアンサーを先頭に表示
      answers.sort((a, b) => {
        if (a.is_best_answer && !b.is_best_answer) return -1;
        if (!a.is_best_answer && b.is_best_answer) return 1;
        return new Date(a.created_at) - new Date(b.created_at);
      });

      answers.forEach(answer => {
        const card = createAnswerCard(answer);
        container.appendChild(card);
      });
    }

    function createAnswerCard(answer) {
      const card = document.createElement('div');
      card.className = answer.is_best_answer ? 'answer-card best-answer' : 'answer-card';

      const baButton = (isLoggedIn() && currentThread && currentThread.user_id === currentUser?.id && !answer.is_best_answer)
        ? `<button class="btn-primary" onclick="selectBA(${answer.id})">ベストアンサーに選ぶ</button>`
        : '';

      card.innerHTML = `
        <div class="answer-header">
          <div class="answer-author-info">
            <strong>${escapeHtml(answer.user?.display_name || answer.user?.email || '')}</strong>
            ${answer.is_best_answer ? '<span class="best-answer-badge">ベストアンサー</span>' : ''}
          </div>
        </div>
        <div class="answer-content">${nl2br(answer.content)}</div>
        <div class="answer-footer">
          <span>${formatDate(answer.created_at)}</span>
          <div class="answer-actions">
            ${baButton}
          </div>
        </div>
      `;

      return card;
    }

    // 回答を投稿
    async function handleAnswerSubmit(event) {
      event.preventDefault();

      const content = document.getElementById('answer-content').value;

      if (!content) {
        showError('回答内容を入力してください');
        return;
      }

      try {
        showLoading();

        await createAnswer(threadId, content);

        hideLoading();
        showSuccess('回答を投稿しました');

        // フォームをクリア
        document.getElementById('answer-content').value = '';

        // 回答一覧を再読み込み
        setTimeout(() => {
          loadAnswers();
        }, 1000);
      } catch (error) {
        hideLoading();
        showError(error.message || '回答の投稿に失敗しました');
      }
    }

    // ベストアンサーを選択
    async function selectBA(answerId) {
      if (!confirm('この回答をベストアンサーに選びますか？\nスレッドは解決済みになります。')) {
        return;
      }

      try {
        showLoading();

        await selectBestAnswer(answerId);

        hideLoading();
        showSuccess('ベストアンサーを選択しました');

        // ページを再読み込み
        setTimeout(() => {
          location.reload();
        }, 1000);
      } catch (error) {
        hideLoading();
        showError(error.message || 'ベストアンサーの選択に失敗しました');
      }
    }

    // 現在のユーザー情報を取得
    async function loadCurrentUser() {
      if (isLoggedIn()) {
        try {
          const response = await getCurrentUser();
          currentUser = response.user;
        } catch (error) {
          console.error('Failed to get current user:', error);
        }
      }
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', async () => {
      await loadCurrentUser();
      loadThreadDetail();

      const answerForm = document.getElementById('answer-form');
      if (answerForm) {
        answerForm.addEventListener('submit', handleAnswerSubmit);
      }
    });
  </script>
</body>
</html>
