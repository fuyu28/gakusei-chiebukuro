<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç”ŸçŸ¥æµè¢‹ - ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</title>
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/threads.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="index.html" class="logo">å­¦ç”ŸçŸ¥æµè¢‹</a>

        <nav>
          <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ -->
          <div class="logged-in" style="display: none;">
            <span id="user-info"></span>
            <a href="new-thread.html" class="btn-primary">è³ªå•ã™ã‚‹</a>
            <a href="#" id="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
          </div>

          <!-- æœªãƒ­ã‚°ã‚¤ãƒ³ -->
          <div class="logged-out">
            <a href="login.html">ãƒ­ã‚°ã‚¤ãƒ³</a>
            <a href="signup.html" class="btn-primary">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ</a>
          </div>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="page-header">
      <h1 class="page-title">è³ªå•ä¸€è¦§</h1>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ -->
    <div class="filter-bar">
      <div class="filter-group">
        <label class="filter-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</label>
        <select id="status-filter" class="filter-select">
          <option value="">ã™ã¹ã¦</option>
          <option value="open">æœªè§£æ±º</option>
          <option value="resolved">è§£æ±ºæ¸ˆã¿</option>
        </select>

        <label class="filter-label">ç§‘ç›®:</label>
        <select id="subject-filter" class="filter-select">
          <option value="">ã™ã¹ã¦</option>
          <!-- ç§‘ç›®ã‚¿ã‚°ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
        </select>

        <label class="filter-label">ä¸¦ã³é †:</label>
        <select id="sort-filter" class="filter-select">
          <option value="created_at">æŠ•ç¨¿æ—¥æ™‚</option>
          <option value="updated_at">æ›´æ–°æ—¥æ™‚</option>
        </select>
      </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="error-message" class="error-message"></div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
    </div>

    <!-- ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ -->
    <div id="threads-list" class="threads-list">
      <!-- ã‚¹ãƒ¬ãƒƒãƒ‰ã‚«ãƒ¼ãƒ‰ãŒJavaScriptã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
    </div>

    <!-- ç©ºçŠ¶æ…‹ -->
    <div id="empty-state" class="empty-state" style="display: none;">
      <div class="empty-state-icon">ğŸ“</div>
      <p class="empty-state-message">è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“</p>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2024 å­¦ç”ŸçŸ¥æµè¢‹. All rights reserved.</p>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    let currentFilters = {};

    async function loadThreads() {
      try {
        showLoading();
        hideElement('#empty-state');

        const threads = await fetchThreads(currentFilters);

        hideLoading();

        if (threads.length === 0) {
          showElement('#empty-state');
          return;
        }

        renderThreads(threads);
      } catch (error) {
        hideLoading();
        showError(error.message || 'ã‚¹ãƒ¬ãƒƒãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function renderThreads(threads) {
      const container = document.getElementById('threads-list');
      container.innerHTML = '';

      threads.forEach(thread => {
        const card = createThreadCard(thread);
        container.appendChild(card);
      });
    }

    function createThreadCard(thread) {
      const card = document.createElement('div');
      card.className = 'thread-card';
      card.onclick = () => navigateTo(`thread.html?id=${thread.id}`);

      const statusClass = thread.status === 'open' ? 'status-open' : 'status-resolved';
      const statusText = thread.status === 'open' ? 'æœªè§£æ±º' : 'è§£æ±ºæ¸ˆã¿';

      card.innerHTML = `
        <div class="thread-header">
          <h2 class="thread-title">${escapeHtml(thread.title)}</h2>
          <span class="thread-status ${statusClass}">${statusText}</span>
        </div>
        <p class="thread-content">${escapeHtml(thread.content.substring(0, 150))}${thread.content.length > 150 ? '...' : ''}</p>
        <div class="thread-meta">
          <span class="thread-tag">${escapeHtml(thread.subject_tag?.name || '')}</span>
          <div class="thread-info">
            <span class="thread-author">æŠ•ç¨¿è€…: ${escapeHtml(thread.user?.display_name || thread.user?.email || '')}</span>
            <span class="thread-date">${timeAgo(thread.created_at)}</span>
            <span class="thread-answers-count">å›ç­”: ${thread.answers_count || 0}ä»¶</span>
          </div>
        </div>
      `;

      return card;
    }

    async function loadSubjectTags() {
      try {
        const tags = await fetchSubjectTags();
        const select = document.getElementById('subject-filter');

        tags.forEach(tag => {
          const option = document.createElement('option');
          option.value = tag.id;
          option.textContent = tag.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Failed to load subject tags:', error);
      }
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´æ™‚ã®å‡¦ç†
    document.getElementById('status-filter').addEventListener('change', (e) => {
      currentFilters.status = e.target.value || undefined;
      loadThreads();
    });

    document.getElementById('subject-filter').addEventListener('change', (e) => {
      currentFilters.subject_tag_id = e.target.value ? parseInt(e.target.value) : undefined;
      loadThreads();
    });

    document.getElementById('sort-filter').addEventListener('change', (e) => {
      currentFilters.sort = e.target.value;
      loadThreads();
    });

    // åˆæœŸèª­ã¿è¾¼ã¿
    document.addEventListener('DOMContentLoaded', () => {
      loadSubjectTags();
      loadThreads();
    });
  </script>
</body>
</html>
